---
  flow-definitions:
    - name: 'bayesianPackageAnalysisFlow'
      queue: '{DEPLOYMENT_PREFIX}_ingestion_bayesianPackageAnalysisFlow_v0'
      sampling:
        name: 'constant'
        args:
          retry: 10
      edges:
        - from:
          to: 'github_details'
          condition: &isGhRepoCheck
            name: 'isGhRepo'
            args:
              key: 'url'

        - from:
          to: 'GitReadmeCollectorTask'
          condition:
            <<: *isGhRepoCheck

        - from:
          to: 'RepositoryDescCollectorTask'
          condition: &repositoryDescCollectorCheck
            or:
              - name: 'argsFieldEqual'
                args:
                  key: 'ecosystem'
                  value: 'pypi'
              - name: 'argsFieldEqual'
                args:
                  key: 'ecosystem'
                  value: 'npm'

        - from: 'GitReadmeCollectorTask'
          to: 'package_keywords_tagging'
          condition:
            and:
              - &keywordsTaggingCheck
                or:
                  - name: 'argsFieldEqual'
                    args:
                      key: 'ecosystem'
                      value: 'pypi'
                  - name: 'argsFieldEqual'
                    args:
                      key: 'ecosystem'
                      value: 'maven'
              - not:
                  # prevent package_keywords_tagging to be run twice
                  <<: *repositoryDescCollectorCheck

        - from:
            - 'GitReadmeCollectorTask'
            - 'RepositoryDescCollectorTask'
          to: 'package_keywords_tagging'
          condition:
            and:
              - <<: *keywordsTaggingCheck
              # prevent package_keywords_tagging to be run twice
              # TODO: it would be nice to have https://github.com/selinon/selinon/issues/22 to avoid this check
              - <<: *repositoryDescCollectorCheck

        - from:
          to: 'git_stats'
          condition:
            <<: *isGhRepoCheck

        - from:
          to: 'libraries_io'
